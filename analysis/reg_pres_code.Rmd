---
title: "Data Cleaning & EDA"
author: "Ethan Feldman, Michael Lewis"
date: "2022-12-01"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Libraries

```{r, include=FALSE}
library(tidyverse)
library(MASS)
library(car)
```

# Reading In the Raw Data

```{r}
income_df <- read_csv("../data/data-clean.csv")
head(income_df)
nrow(income_df)
colnames(income_df)

mutate(income_df, race = as_factor(race)) -> income_df
mutate(income_df, sex = as_factor(sex)) -> income_df
mutate(income_df, industry = as_factor(industry)) -> income_df
mutate(income_df, education = as_factor(education)) -> income_df
```

# EDA on raw data

## Graphs

```{r}
ggplot(data = income_df, mapping = aes(x = hours.week))+
  geom_histogram()

ggplot(data = income_df, mapping = aes(x = sex))+
  geom_bar()

ggplot(data = income_df, mapping = aes(x = education))+
  geom_bar()+
  coord_flip()

ggplot(data = income_df, mapping = aes(x = total.person.earnings))+
  geom_histogram()

ggplot(data = income_df, mapping = aes(x = full_time_labor_force))+
  geom_bar()

ggplot(data = income_df, mapping = aes(x = health.status))+
  geom_bar()

ggplot(data = income_df, mapping = aes(x = race))+
  geom_bar()+
  coord_flip()

ggplot(data = income_df, mapping = aes(x = industry))+
  geom_bar()+
  coord_flip()
```

# Numerical Summaries

```{r}

```

# Data Cleaning & Transformations

## Logging earnings

Because the response data (earnings) is skewed, we log the data to make it more normal.

```{r}
income_df %>% 
  mutate(earningslog = log(total.person.earnings)) %>%
  filter(earningslog != "-Inf") %>% #removing undefined results
  filter(earningslog != "Inf") %>% #removing undefined results
  filter(!is.nan(earningslog)) -> income_df_logged #removing anything else 

ggplot(data = income_df_logged, mapping = aes(x = earningslog))+
  geom_histogram(bins = 25) #data looks more normal / unimodal 

```

## Filtering down to the IQR

Our project is aimed at understanding the average American's income. As a result, we filtered our dataset down to the middle 50% of individuals.

```{r}
summary(income_df_logged$total.person.earnings)

#lower threshold 32000
#upper threshold 83000

income_df_logged %>% 
  filter(total.person.earnings > 32000) %>%
  filter(total.person.earnings < 83000) -> income_IQR
head(income_IQR)

income_IQR$race  <- as_factor(income_IQR$race)
income_IQR$education  <- as_factor(income_IQR$education)
income_IQR$industry  <- as_factor(income_IQR$industry)
income_IQR$sex <- as_factor(income_IQR$sex)

income_IQR$race <- fct_collapse(income_IQR$race,
                                      White = "White only",
                                      Black = "Black only",
                  American_native = "American Indian, Alaskan Native only (AI)",
                  Asian = "Asian only",
                  HI_PI = "Hawaiian/Pacific Islander only (HP)",
                  multi_racial = c("White-Black", "Black-AI", "White-AI",
                                   "White-Asian", "White-Black-AI-Asian",
                                   "White-Black-Asian", "AI-Asian",
                                   "White-Asian-HP", "White-Black-AI", 
                                   "White-AI-Asian", "Black-Asian", 
                                   "White-AI-Asian-HP", "Black-AI-Asian",
                                   "White-Black-HP", "Asian-HP", "Black-HP",
                                   "White-AI-HP", "AI-HP", "Other 4 or 5 race comb.",
                                   "Other 3 race comb.", "White-HP"))

income_IQR$education <- fct_collapse(income_IQR$education,
          less_than_hs = c("Less than 1st grade", "5th or 6th grade",
                              "9th grade","1st,2nd,3rd,or 4th grade",
                              "12th grade no diploma", "10th grade",
                              "11th grade", "7th and 8th grade"),
          hs_grad = "High school graduate - high school diploma or equivalent", 
             col_nd = "Some college but no degree",
          associates = c("Associate degree in college - occupation/vocation program",
          "Associate degree in college - academic program"),
          bsba = "Bachelors degree",
          advanced = c("Masters degree", "Professional school degree",
                       "Doctorate degree"))

levels(income_IQR$education)
levels(income_IQR$race)



```


```{r}
step(model1, earningslog ~ race + education + industry + sex, direction = "both")
```


## Model 1: Log Earnings = ð›ƒ0 + ð›ƒ1\*Race

Model Coefficients:

```{r}
lm(earningslog ~ race, data = income_IQR) -> model1
broom::tidy(model1$coefficients) 
```

Significant Model Coefficients (at alpha = .05):

```{r}
broom::tidy(summary(model1)) %>% filter(p.value < .05)
```

ANOVA Table

```{r}
broom::tidy(anova(model1))
```

```{r}
plot(model1) #include first two plots

#generally normal notwithstanding deviations at tail ends
#residuals -- NCV
```

## Model 2: Log Earnings = ð›ƒ0 + ð›ƒ1\*Race + ð›ƒ2\*Industry

Model Coefficients:

```{r}
lm(earningslog ~ race + industry, data = income_IQR) -> model2
broom::tidy(model2$coefficients) 
```

Significant Model Coefficients (at alpha = .05):

```{r}
broom::tidy(summary(model2)) %>% filter(p.value < .05)
```

ANOVA Table

```{r}
broom::tidy(anova(model2))
```

```{r}
plot(model2)
#definitely should remove case on far right and far left
#residuals appear to be slightly downward sloping but are generally within -.6 and .6. Variance is relatively constant. 
#Again, normal except for tail ends in theoretical quantiles below -1.5 and 1.5
```
